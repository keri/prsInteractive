version 1.0

workflow prsInteractivePipeline {
    input {
        String pheno
        String icd10
        String pheno_str
        String platform
        String root_directory
        Int n
        Array[File] raw_variant_calls
        File participant_hla
        File participant_data
        File participant_environment
        File covar
        File hla_headers
        File withdrawals
        File scripts_archive
    }
    
    # Set up the environment variables and create pheno folder
    call createSummary {
        input:
            pheno = pheno,
            icd10 = icd10,
            pheno_str = pheno_str,
            platform = platform
    }
    
    # Run the train test holdout split and phenotype creation
    call runTrainTestHoldoutSplitPhenotype {
        input:
            pheno = pheno,
            icd10 = icd10,
            pheno_str = pheno_str,
            root_directory = root_directory,
            scripts_archive = scripts_archive,
            participant_data = participant_data,
            participant_environment = participant_environment
    }
    
    output {
        File summary_file = createSummary.summary_file
        File completion_file = runTrainTestHoldoutSplitPhenotype.completion_file
        Array[File] pheno_files = runTrainTestHoldoutSplitPhenotype.pheno_files
    }
}

task createSummary { 
    input {
        String pheno
        String icd10
        String pheno_str
        String platform
    }
    
    command <<<
        set -e
        
        echo "Processing phenotype: ~{pheno}"
        echo "Using pheno string: ~{pheno_str}"
        echo "With icd10: ~{icd10}"
        
        # Debug information
        echo "Current working directory: $(pwd)"
        echo "Current user: $(whoami)"
        echo "Available directories:"
        ls -la /
        
        # Create summary file in working directory
        ts=$(date +%Y%m%d_%H%M%S)
        summaryFile="summary.txt"
        touch "${summaryFile}"
        echo "timestamp of analysis: ${ts}" >> "${summaryFile}"
        echo "phenotype analyzed: ~{pheno}" >> "${summaryFile}"
        echo "phenotype substring filtered in participant.csv: ~{pheno_str}" >> "${summaryFile}"
        echo "icd 10 code used to define phenotype: ~{icd10}" >> "${summaryFile}"
        echo "user running workflow: $(whoami)" >> "${summaryFile}"
        echo "running on platform: ~{platform}" >> "${summaryFile}"
        
        # Verify file was created
        echo "Summary file contents:"
        cat $summaryFile
    >>>
    
    runtime {
        docker: "ukb-base:V1"
        memory: "2GB"
        cpu: 1
    }
    
    output {
        File summary_file = "summary.txt"
    }
}

task runTrainTestHoldoutSplitPhenotype {
    input {
        String pheno
        String icd10
        String pheno_str
        String root_directory
        File scripts_archive
        File participant_data
        File participant_environment
    }
    
    command <<<
        set -e
        
        # Extract scripts archive
        echo "Extracting scripts archive..."
        if [[ "~{scripts_archive}" == *.tar.gz ]]; then
            tar -xzf ~{scripts_archive}
        elif [[ "~{scripts_archive}" == *.zip ]]; then
            unzip ~{scripts_archive}
        else
            echo "Unknown archive format for ~{scripts_archive}"
            exit 1
        fi
        
        # Create local data directory and copy input files
        mkdir -p ./data
        cp ~{participant_data} ./data/participant.csv
        cp ~{participant_environment} ./data/participant_environment.csv
        
        # Create results directory
        mkdir -p ./results/~{pheno}
        
        # Debug information
        echo "Current working directory: $(pwd)"
        echo "Files in current directory:"
        ls -la
        echo "Files in data directory:"
        ls -la ./data/
        
        # Verify required files exist
        if [ -f "./data/participant.csv" ]; then
            echo "✅ participant.csv found"
            echo "File size: $(wc -l < ./data/participant.csv) lines"
            echo "First few lines:"
            head -3 ./data/participant.csv
        else
            echo "❌ participant.csv not found"
            exit 1
        fi
        
        if [ -f "./data/participant_environment.csv" ]; then
            echo "✅ participant_environment.csv found"
        else
            echo "❌ participant_environment.csv not found"
            exit 1
        fi
        
        # Find Python scripts
        echo "Looking for Python scripts..."
        find . -name "*.py" -type f
        
        # Verify the main script exists
        MAIN_SCRIPT=$(find . -name "create_pheno_train_test_split.py" -type f | head -1)
        if [ -z "$MAIN_SCRIPT" ]; then
            echo "❌ create_pheno_train_test_split.py not found"
            echo "Available Python files:"
            find . -name "*.py" -type f
            exit 1
        fi
        
        echo "✅ Using script: $MAIN_SCRIPT"
        
        # Activate conda environment
        eval "$(conda shell.bash hook)"
        conda activate ukb_env
        
        # Verify Python environment
        echo "Python version: $(python --version)"
        echo "Python path: $(which python)"
        
        # Run the Python script
        echo "Running Python script..."
        python "$MAIN_SCRIPT" \
            --data_path ./data \
            --icd10 ~{icd10} \
            --pheno ~{pheno} \
            --pheno_str "~{pheno_str}" \
            --pheno_path ./results/~{pheno}
        
        # Verify output files were created
        echo "Checking output files..."
        ls -la ./results/~{pheno}/
        
        # Create completion file
        echo "train test split and phenotype creation complete" > completion_file.txt
        echo "Successfully processed ~{pheno} with ICD10 ~{icd10}" >> completion_file.txt
        echo "Output files created in ./results/~{pheno}/" >> completion_file.txt
    >>>
    
    runtime {
        docker: "ukb-base:V1"
        memory: "50GB"
        cpu: 1
    }
    
    output {
        File completion_file = "completion_file.txt"
        Array[File] pheno_files = glob("./results/~{pheno}/*.txt")
    }
}