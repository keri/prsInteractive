#!/bin/bash

import pandas as pd
import numpy as np
import os
import argparse




def main(df2,pheno,pheno_path,icd_code="E11",pheno_str="type 2 diabetes"):
    '''
    input:
        df2 : pandas.DataFrame() with 
        minimum columns needed = ['Non-cancer illness code, self-reported | Instance 0',
        'Non-cancer illness code, self-reported | Instance 1',
        'Non-cancer illness code, self-reported | Instance 2',
        'Non-cancer illness code, self-reported | Instance 3',
        'Diagnoses - main ICD10',
        'Participant ID'

    output:
        Four .txt files space delimited
             traininingID.txt, testID.txt, holdoutID.txt, pheno.txt
    '''
    
    
    ###########################  DEFINE PHENOTYPE  #######################
    if pheno == "type2Diabetes":
        phenoDf = df2[(df2['Date E11 first reported (non-insulin-dependent diabetes mellitus)'] != '') | 
            (df2['Source of report of E11 (non-insulin-dependent diabetes mellitus)'] != '') |
            (df2['Non-cancer illness code, self-reported | Instance 0'].str.contains('type 2 diabetes')) | 
            (df2['Non-cancer illness code, self-reported | Instance 1'].str.contains('type 2 diabetes')) | 
            (df2['Non-cancer illness code, self-reported | Instance 2'].str.contains('type 2 diabetes')) | 
            (df2['Non-cancer illness code, self-reported | Instance 3'].str.contains('type 2 diabetes')) | 
            (df2['Diagnoses - main ICD10'].str.contains('E11'))]
    elif pheno == 'celiacDisease':
        phenoDf = df2[(df2['Date K90 first reported (intestinal malabsorption)'] != '') | 
            (df2['Source of report of K90 (intestinal malabsorption)'] != '') |
            (df2['Non-cancer illness code, self-reported | Instance 0'].str.contains('coeliac disease')) | 
            (df2['Non-cancer illness code, self-reported | Instance 1'].str.contains('coeliac disease')) | 
            (df2['Non-cancer illness code, self-reported | Instance 2'].str.contains('coeliac disease')) | 
            (df2['Non-cancer illness code, self-reported | Instance 3'].str.contains('coeliac disease')) | 
            (df2['Diagnoses - main ICD10'].str.contains('K90'))]
        
    else:
        phenoDf = df2[(df2['Non-cancer illness code, self-reported | Instance 0'].str.contains(pheno_str)) | 
            (df2['Non-cancer illness code, self-reported | Instance 1'].str.contains(pheno_str)) | 
            (df2['Non-cancer illness code, self-reported | Instance 2'].str.contains(pheno_str)) | 
            (df2['Non-cancer illness code, self-reported | Instance 3'].str.contains(pheno_str)) | 
            (df2['Diagnoses - main ICD10'].str.contains(icd_code))]
    
    #create a phenotype column with name of pheno and create binary phenotype
    df2.loc[phenoDf.index, 'phenotype'] = 2
    df2.fillna(1,inplace=True)
    
    
    print('phenotype prevalence in total = ',phenoDf.shape[0]/df2.shape[0])
    
    ##################### SPLIT DATA INTO TRAIN/TEST/HOLDOUT  #################################
    
    #filter 20% test set with same frequency of celiac and type 2 diabetes
    #filter 10% holdout set
    #filter cases and controls separately
    
    training = df2.groupby("phenotype").sample(frac=.70,random_state=1)
    print('training data consists of ',training.shape,' # of people')
    
    #get new dataset without rows in training dataset
    df3 = df2[~df2.index.isin(training.index)]
    
    #proportion of remaining dataset to test set = 66%
    test = df3.groupby("phenotype").sample(frac=.6666,random_state=1)
    print('test data consists of ',test.shape,' # of people')
    
    holdout = df3[~df3.index.isin(test.index)]
    print('holdout data consists of ',holdout.shape,' # of people')
    
    
    #statistics on datasets
    #training
    controls = training.groupby('phenotype').count().loc[1]['Participant ID']
    cases = training.groupby('phenotype').count().loc[2]['Participant ID']
    print('% of cases in training set : ',(cases / training.shape[0])*100)
    print('total cases in training set : ',cases)
    print('total controls in training set : ',controls)
    print()
    
    #holdout data
    controls = holdout.groupby('phenotype').count().loc[1]['Participant ID']
    cases = holdout.groupby('phenotype').count().loc[2]['Participant ID']
    print('% of cases in holdout set : ',(cases / holdout.shape[0])*100)
    print('total cases in holdout set : ',cases)
    print('total controls in holdout set : ',controls)
    print()
    
    #test data
    controls = test.groupby('phenotype').count().loc[1]['Participant ID']
    cases = test.groupby('phenotype').count().loc[2]['Participant ID']
    print('% of cases in test set : ',(cases / test.shape[0])*100)
    print('total cases in test set : ',cases)
    print('total controls in test set : ',controls)
    
    #training IDs
    trainingID = training[['Participant ID']]
    trainingID['IID'] = training['Participant ID']
    #holdout IDs
    holdoutID = holdout[['Participant ID']]
    holdoutID['IID'] = holdout['Participant ID']
    #test IDs
    testID = test[['Participant ID']]
    testID['IID'] = test['Participant ID']
    #phenotype for all individuals
    phenotype = df2[['Participant ID']]
    phenotype['IID'] = df2['Participant ID']
    phenotype['phenotype'] = df2['phenotype']
    
    
    #save to directory
    testID.to_csv(f'{pheno_path}/testID.txt',sep=' ',header=None,index=False)
    holdoutID.to_csv(f'{pheno_path}/holdoutID.txt',sep=' ',header=None,index=False)
    trainingID.to_csv(f'{pheno_path}/trainingID.txt',sep=' ',header=None,index=False)
    phenotype.to_csv(f'{pheno_path}/pheno.txt',sep=' ',header=None,index=False)

if __name__ == "__main__":
    
    parser = argparse.ArgumentParser(description="creating phenotype file...")
    parser.add_argument("--data_path", help="Path to the prsInteractive data folder")
    parser.add_argument("--pheno_path", help="Path to the input pheno results folder")
    parser.add_argument("--pheno", help="Phenotype to analyze")
    parser.add_argument("--pheno_str", help="Phenotype string used in Non-cancer illness code, self-reported field")
    parser.add_argument("--icd10", help="ICD 10 code of phenotype")
    
    
    args = parser.parse_args()
    
    # Prefer command-line input if provided; fallback to env var
    data_path = args.data_path or os.environ.get("DATA_PATH")
    print(f"[PYTHON] Reading from: {data_path}")
    
    pheno_path = args.pheno_path or os.environ.get("PHENO_PATH")
    print(f"[PYTHON] Reading from: {pheno_path}")
    
    pheno = args.pheno or os.environ.get("PHENO")
    print(f"[PYTHON] Phenotype : {pheno}")
    
    icd10 = args.icd10 or os.environ.get("ICD10")
    print(f"[PYTHON] icd code : {icd10}")
    
    pheno_str = args.pheno_str or os.environ.get("PHENO_STR")
    print(f"[PYTHON] Phenotype string to filter for : {pheno_str}")
    
    if not data_path:
        raise ValueError("You must provide a data path via --data_path directory or set the DATA_PATH environment variable.")
        
    if not pheno_path:
        raise ValueError("You must provide a data pheno path via --pheno_folder or set the PHENO_PATH environment variable.")
        
    if not pheno:
        raise ValueError("You must provide a phenotype via --pheno or set the PHENO environment variable.")
        
    if not pheno_str:
        raise ValueError("You must provide a phenotype string used in Non-cancer illness code via --pheno_str or set the PHENO_STR environment variable.")
        
    if not icd10:
        raise ValueError("You must provide a ICD 10 code via --icd10 or set the ICD_CODE environment variable.")
        
    
    #############################  DOWNLOAD PARTICIPANT DATASET  ###################
    df = pd.read_csv(f'{data_path}/participant.csv')
    df2 = df.fillna('')
    
    main(df2, pheno, pheno_path, icd_code=icd,pheno_str=pheno_str)